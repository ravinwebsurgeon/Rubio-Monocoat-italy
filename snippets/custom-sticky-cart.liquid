<div id="sticky-add-to-cart">
  <div class="sticky-inner">
    <!-- Product Info -->
    <div class="sticky-product-info">
      <img 
        src="{{ product.featured_image | img_url: '100x100' }}" 
        alt="{{ product.title }}" 
        id="sticky-variant-image"
      >
      <div class="sticky-details">
        <span class="sticky-title" id="sticky-variant-title">{{ product.title }}</span>

        <!-- âœ… Selected Options will appear here -->
        <div class="sticky_variant_options_main">
          <span class="sticky-variant-options" id="sticky-variant-options">
            {% if product.selected_or_first_available_variant %}
              {{ product.selected_or_first_available_variant.option1 }}
              {% if product.selected_or_first_available_variant.option2 %}
                / {{ product.selected_or_first_available_variant.option2 }}
              {% endif %}
            {% endif %}
          </span>
          <a href="#variant-selects-{{ section.id }}" class="change_variants"><span>Change</span></a>
      </div>
      </div>
    </div>

    <div class="center Sticky_price_section">
       <span class="sticky-price" id="sticky-price">
          {{ product.selected_or_first_available_variant.price | money_with_currency }}    
       </span>
      <!-- Add to Cart -->
      <form method="post" action="/cart/add" class="sticky-form">
        <input
          type="hidden"
          name="id"
          id="sticky-variant-id"
          value="{{ product.selected_or_first_available_variant.id }}"
        >
        <button type="submit" class="sticky-btn">Add to Cart</button>
      </form>
    </div>
  </div>
</div>

<script>  
document.addEventListener('DOMContentLoaded', function () {
  const stickyForm = document.querySelector('.sticky-form');
  const stickyVariantIdEl = document.getElementById('sticky-variant-id');
  const stickyOptionsEl = document.getElementById('sticky-variant-options');
  const stickyPriceEl = document.getElementById('sticky-price');
  const stickyImgEl = document.getElementById('sticky-variant-image');
  const stickyBar = document.getElementById('sticky-add-to-cart');
  const mainAddToCartBtn = document.querySelector('.product-form__submit[name="add"]'); // main add-to-cart

  if (!stickyForm || !stickyBar) return;

  // ===== Sticky bar show/hide on scroll =====
  const productForm = document.querySelector('form[action="/cart/add"]');
  window.addEventListener('scroll', function () {
    const rect = productForm.getBoundingClientRect();
    stickyBar.style.display = rect.bottom < 0 ? 'flex' : 'none';
  });

  // ===== Get currently selected variant =====
  function getCurrentSelectedVariant() {
    const jsonEl = document.querySelector('[data-selected-variant]');
    if (!jsonEl) return null;
    try {
      return JSON.parse(jsonEl.textContent);
    } catch (e) {
      return null;
    }
  }

  // ===== Update sticky bar info =====
  function updateStickyBar() {
    const variant = getCurrentSelectedVariant();
    if (!variant) return;
    const moneyFormat = window.Shopify?.shop?.money_format || '{{ shop.money_format }}';
    const currencyCode = window.Shopify?.currency?.active || '{{ cart.currency.iso_code }}' || 'USD';

    stickyOptionsEl.textContent = variant.options.filter(Boolean).join(' / ');

    if (typeof Shopify !== 'undefined' && Shopify.formatMoney) {
      {% comment %} stickyPriceEl.innerHTML = Shopify.formatMoney(
        variant.price,
        window.meta?.money_format || '{{ shop.money_format }}'
      ); {% endcomment %}
      stickyPriceEl.innerHTML = Shopify.formatMoney(variant.price, moneyFormat);
    } else {
      {% comment %} stickyPriceEl.textContent = (variant.price / 100).toFixed(2); {% endcomment %}
       const formattedPrice = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: currencyCode
    }).format(variant.price / 100);
    stickyPriceEl.textContent = formattedPrice;
    }

    stickyVariantIdEl.value = variant.id;

    if (variant.featured_image && stickyImgEl) {
      stickyImgEl.src = variant.featured_image.src;
    }
  }

  setInterval(updateStickyBar, 1000);
  updateStickyBar();

  // ===== Trigger main Add to Cart when sticky clicked =====
  stickyForm.addEventListener('submit', function (e) {
    e.preventDefault();

    // Update the main variant selection if needed
    const currentVariant = getCurrentSelectedVariant();
    if (currentVariant && stickyVariantIdEl.value != currentVariant.id) {
      stickyVariantIdEl.value = currentVariant.id;
    }

    // Trigger main Add to Cart button
    if (mainAddToCartBtn) {
      mainAddToCartBtn.click(); 
    } else {
      console.warn('Main Add to Cart button not found.');
    }
  });
});
</script>