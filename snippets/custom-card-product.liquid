{% comment %}
  Renders a product card
  Accepts:
  - card_product: {Object} Product Liquid object
  - show_secondary_image, show_vendor, show_rating, quick_add, section_id, etc.
{% endcomment %}

{%- unless skip_styles -%}
  {{ 'component-rating.css' | asset_url | stylesheet_tag }}
  {{ 'component-volume-pricing.css' | asset_url | stylesheet_tag }}
  {{ 'component-price.css' | asset_url | stylesheet_tag }}
  {{ 'quick-order-list.css' | asset_url | stylesheet_tag }}
  {{ 'quantity-popover.css' | asset_url | stylesheet_tag }}
{%- endunless -%}

{%- if card_product and card_product != empty -%}
  {%- liquid
    assign ratio = 1
    if card_product.featured_media and media_aspect_ratio == 'portrait'
      assign ratio = 0.8
    elsif card_product.featured_media and media_aspect_ratio == 'adapt'
      assign ratio = card_product.featured_media.aspect_ratio
    endif
    if ratio == 0 or ratio == null
      assign ratio = 1
    endif
  -%}

  <div class="card-wrapper product-card-wrapper underline-links-hover">
    <div
      class="card card--{{ settings.card_style }}
        {% if card_product.featured_media %} card--media{% else %} card--text{% endif %}
        {% if settings.card_style == 'card' %} color-{{ settings.card_color_scheme }} gradient{% endif %}
        {% if image_shape and image_shape != 'default' %} card--shape{% endif %}
        {% if extend_height %} card--extend-height{% endif %}
        {% if horizontal_class %} card--horizontal{% endif %}"
      style="--ratio-percent: {{ 1 | divided_by: ratio | times: 100 }}%;"
    >
      <div
        class="card__inner {% if settings.card_style == 'standard' %}color-{{ settings.card_color_scheme }} gradient{% endif %}{% if card_product.featured_media or settings.card_style == 'standard' %} ratio{% endif %}"
        style="--ratio-percent: {{ 1 | divided_by: ratio | times: 100 }}%;"
      >
        {% if card_product.featured_media %}
          <div class="card__media {% if image_shape and image_shape != 'default' %} shape--{{ image_shape }} color-{{ settings.card_color_scheme }} gradient{% endif %}">
           
              <div class="media media--transparent media--hover-effect">
               <a href="{{ card_product.url }}">
              <img
                srcset="
                  {%- if card_product.featured_media.width >= 165 -%}{{ card_product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 360 -%}{{ card_product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 533 -%}{{ card_product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 720 -%}{{ card_product.featured_media | image_url: width: 720 }} 720w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 940 -%}{{ card_product.featured_media | image_url: width: 940 }} 940w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 1066 -%}{{ card_product.featured_media | image_url: width: 1066 }} 1066w,{%- endif -%}
                  {{ card_product.featured_media | image_url }} {{ card_product.featured_media.width }}w
                "
                src="{{ card_product.featured_media | image_url: width: 533 }}"
                sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px,
                       (min-width: 990px) calc((100vw - 130px) / 4),
                       (min-width: 750px) calc((100vw - 120px) / 3),
                       calc((100vw - 35px) / 2)"
                alt="{{ card_product.featured_media.alt | escape }}"
                class="motion-reduce"
                {% unless lazy_load == false %}loading="lazy"{% endunless %}
                width="{{ card_product.featured_media.width }}"
                height="{{ card_product.featured_media.height }}"
              >

              {% if card_product.media[1] != null and show_secondary_image %}
                <img
                  src="{{ card_product.media[1] | image_url: width: 533 }}"
                  alt="{{ card_product.media[1].alt | escape }}"
                  loading="lazy"
                >
              {% endif %}
              </a>
            </div>
          
          </div>
        {% endif %}

        <div class="card__content">
          <div class="card__information">
            <h3 class="card__heading">
              <a href="{{ card_product.url }}" class="full-unstyled-link">{{ card_product.title | escape }}</a>
            </h3>
          </div>
          <div class="card__badge {{ settings.badge_position }}">
            {% if card_product.available == false %}
              <span class="badge badge--bottom-left color-{{ settings.sold_out_badge_color_scheme }}">{{ 'products.product.sold_out' | t }}</span>
            {% elsif card_product.compare_at_price > card_product.price and card_product.available %}
              <span class="badge badge--bottom-left color-{{ settings.sale_badge_color_scheme }}">{{ 'products.product.on_sale' | t }}</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card__content">
        <div class="card__information">
          <div class="custom_card_detail">
            <h3 class="card__heading h5">{{ card_product.title | escape }}</h3>
            {% render 'price', product: card_product, price_class: '', show_compare_at_price: true %}
          </div>

          <!-- Variant Section with Swatch Support -->
          <div class="custom_added_variants">
            {% for option in card_product.options_with_values %}
              <div class="pro_variant_options variant__{{ option.name }}">
                {% assign downcase_name = option.name | downcase %}
                {% if downcase_name contains 'color' or downcase_name contains 'colour' %}
                  <div class="color-swatch-group" data-index="option{{ forloop.index }}">
                    {% for value in option.values %}
                      <label
                        class="color-swatch"
                        title="{{ value }}"
                        style="background-color: {{ value | downcase }};"
                      >
                        <input
                          type="radio"
                          name="option-color-{{ forloop.parentloop.index0 }}"
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}checked{% endif %}
                          class="color-swatch-input"
                          data-value="{{ value | escape }}"
                        >
                        <span class="swatch-checkmark"></span>
                      </label>
                    {% endfor %}
                  </div>
                {% else %}
                  <select class="option-variant-selector" name="option-variant-selector" id="ProductSelect-{{ forloop.index0 }}" data-index="option{{ forloop.index }}">
                    {% for value in option.values %}
                      <option 
                        value="{{ value | escape }}"
                        {% if option.selected_value == value %} selected="selected"{% endif %}
                      >
                        {{ value | escape }}
                      </option>
                    {% endfor %}
                  </select>
                {% endif %}
              </div>
            {% endfor %}
            <input type="hidden" class="variant-selector" id="variant-id" name="id" value="{{ card_product.selected_or_first_available_variant.id }}">
          </div>

          {% assign imagesd = card_product.metafields.custom.product_iconss.value %}
          {% assign textsd = card_product.metafields.custom.product_textss.value %}
          {% if imagesd and textsd %}
            {% for image in imagesd %}
              {% assign texts = textsd[forloop.index0] %}
              <div class="meeta-fl">
                {% if image %}
                  <span class="immmg"><img src="{{ image | image_url: width: 600 }}" alt="{{ texts | escape }}"></span>
                {% endif %}
                {% if texts %}
                  <span class="mememe">{{ texts }}</span>
                {% endif %}
              </div>
            {% endfor %}
          {% endif %}

          <!-- Embed product JSON -->
          <script type="application/json" class="product-json">{{ card_product | json }}</script>

          <div class="custom_action_btns">
            <div class="product_actions_btns">
              <a href="{{ card_product.url }}"><button class="product_link_btn">More Info</button></a>
              <button class="product_cart_btn {% unless product.available %} disabled-btn {% endunless %}"
                 {% comment %} {% unless first_variant.available %} disabled {% endunless %} {% endcomment %}
                >Add Into Cart</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card__badge {{ settings.badge_position }}">
        {% if card_product.available == false %}
          <span class="badge badge--bottom-left color-{{ settings.sold_out_badge_color_scheme }}">{{ 'products.product.sold_out' | t }}</span>
        {% elsif card_product.compare_at_price > card_product.price and card_product.available %}
          <span class="badge badge--bottom-left color-{{ settings.sale_badge_color_scheme }}">{{ 'products.product.on_sale' | t }}</span>
        {% endif %}
      </div>
    </div>
  </div>

{%- else -%}
  <!-- Placeholder Product -->
  <div class="card-wrapper product-card-wrapper underline-links-hover">
    <div class="card card--{{ settings.card_style }}">
      <div class="card__inner ratio">
        <div class="media media--transparent">{{ 'product-apparel-2' | placeholder_svg_tag: 'placeholder-svg' }}</div>
      </div>
      <div class="card__content">
        <div class="card__information">
          <h3 class="card__heading card__heading--placeholder h5">
            <a role="link" aria-disabled="true" class="full-unstyled-link">{{ 'onboarding.product_title' | t }}</a>
          </h3>
          {% render 'price', placeholder: true, show_compare_at_price: true %}
        </div>
      </div>
    </div>
  </div>
{%- endif -%}
<style>
  .color-swatch-group {
  display: flex;
  gap: 8px;
  margin-top: 6px;
  flex-wrap: wrap;
}

.color-swatch {
  position: relative;
  width: 26px;
  height: 26px;
  border-radius: 50%;
  cursor: pointer;
  border: 1px solid #ddd;
  overflow: hidden;
  transition: transform 0.2s ease, border-color 0.2s ease;
}

.color-swatch:hover {
  transform: scale(1.1);
  border-color: #000;
}

.color-swatch-input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.color-swatch-input:checked + .swatch-checkmark::after {
  content: "";
  position: absolute;
  inset: 3px;
  border: 2px solid #fff;
  border-radius: 50%;
  box-shadow: 0 0 0 2px #000;
}

.swatch-checkmark::after {
  content: "";
  position: absolute;
  inset: 3px;
  border-radius: 50%;
  background: transparent;
}

</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".product-card-wrapper").forEach(card => {
    const variantInput = card.querySelector(".variant-selector");
    const colorSwatches = card.querySelectorAll(".color-swatch-input");
    const selects = card.querySelectorAll(".option-variant-selector");
    const productJsonEl = card.querySelector(".product-json");
    const addToCartBtn = card.querySelector(".product_cart_btn");
    
    if (!productJsonEl) return;
    const productData = JSON.parse(productJsonEl.textContent);

  // ðŸ”¹ Function to handle variant stock check
    function handleVariantStock(variant) {
      if (!variant) return;
      const qty = variant.inventory_quantity || 0;
      const canContinue = variant.inventory_policy === "continue";
      console.log(variant,'asas')
      if (variant.available) {
        addToCartBtn.classList.add("disabled-btn");
        addToCartBtn.disabled = true;
        {% comment %} addToCartBtn.textContent = "Out of Stock"; {% endcomment %}
      } else {
        addToCartBtn.classList.remove("disabled-btn");
        addToCartBtn.disabled = false;
        {% comment %} addToCartBtn.textContent = "Add to Cart"; {% endcomment %}
      }
    }

    // Handle color swatch selection
    colorSwatches.forEach(swatch => {
      swatch.addEventListener("change", () => {
        const selectedOptions = getSelectedOptions(card);
        const matchedVariant = findVariant(productData, selectedOptions);
        if (matchedVariant) {
          variantInput.value = matchedVariant.id;
          handleVariantStock(matchedVariant);
        }
      });
    });

    // Handle dropdown variant change
    selects.forEach(select => {
      select.addEventListener("change", () => {
        const selectedOptions = getSelectedOptions(card);
        const matchedVariant = findVariant(productData, selectedOptions);
        if (matchedVariant) {
          variantInput.value = matchedVariant.id;
          handleVariantStock(matchedVariant);
        }
      });
    });

    // Handle Add to Cart
    if (addToCartBtn) {
      addToCartBtn.addEventListener("click", async e => {
        e.preventDefault();
        const variantId = variantInput.value;
        const body = JSON.stringify({ items: [{ id: variantId, quantity: 1 }] });

        {% comment %} addToCartBtn.disabled = true; {% endcomment %}
        addToCartBtn.textContent = "Adding..."; 
        
          setTimeout(() => {
            addToCartBtn.textContent = "Add Into Cart";
          }, 1000);
        {% comment %} handleAddToCart(variantId,btn) {% endcomment %}

        {% comment %} addToCartBtn.disabled = false; {% endcomment %}
        {% comment %} addToCartBtn.textContent = "Add Into Cart"; {% endcomment %}
        {% comment %} const res = await fetch("/cart/add.js", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body
        }); {% endcomment %}
 

        {% comment %} if (res.ok) {
          document.dispatchEvent(new CustomEvent("cart:refresh"));
        } else {
          alert("Failed to add to cart. Please try again.");
        } {% endcomment %}
      });
    }

    // Utility functions
    function getSelectedOptions(wrapper) {
      const options = [];
      wrapper.querySelectorAll(".pro_variant_options").forEach(group => {
        const colorInput = group.querySelector(".color-swatch-input:checked");
        const selectInput = group.querySelector("select");
        if (colorInput) options.push(colorInput.value);
        else if (selectInput) options.push(selectInput.value);
      });
      return options;
    }

    function findVariant(product, selectedOptions) {
      return product.variants.find(variant => {
        return JSON.stringify(variant.options) === JSON.stringify(selectedOptions);
      });
    }
  });
});
</script>
