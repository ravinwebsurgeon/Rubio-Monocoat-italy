{%- comment -%}
  Inputs:
    link_url -> the original URL
    lang -> current language ('en', 'it', etc.)
  Output:
    final_url -> processed URL with /en prefix and color translation
{%- endcomment -%}

{% assign colors_it = "Nero,Bianco,Grigio,Rosso,Blu,Scuro,Vivaci,Naturale" | split: "," %}
{% assign colors_en = "Black,White,Grey,Red,Blue,Dark,Bright,Natural" | split: "," %}

{% assign final_url = link_url %}
{% assign country_code = localization.country.iso_code | downcase %}
{% if lang == 'en' %}

  {%- comment -%} Split URL into path + query {%- endcomment -%}
  {% if final_url contains '?' %}
    {% assign path_only = final_url | split:'?' | first %}
    {% assign query_string = final_url | split:'?' | last %}
  {% else %}
    {% assign path_only = final_url %}
    {% assign query_string = '' %}
  {% endif %}

  {%- comment -%} Build EN path WITHOUT query {%- endcomment -%}
  {% unless country_code == 'gb'  or country_code == 'gg' %}
    {% if path_only contains 'http' %}
      {% assign protocol_and_domain = path_only | split:'/' | slice:0,3 | join:'/' %}
      {% assign path_after_domain = path_only | remove_first: protocol_and_domain %}
      {% assign final_url = protocol_and_domain | append:'/en' | append:path_after_domain %}
    {% else %}
      {% unless path_only contains '/en' %}
        {% assign final_url = '/en' | append:path_only %}
      {% else %}
        {% assign final_url = path_only %}
      {% endunless %}
    {% endif %}
  {% endunless %}

  {%- comment -%} Translate query params {%- endcomment -%}
  {% if query_string != '' %}
    {% assign params = query_string | split:'&' %}
    {% assign new_params = '' %}

    {% for p in params %}
      {% assign key = p | split:'=' | first %}
      {% assign value = p | split:'=' | last %}

      {% if key contains 'color' %}
        {% assign color_index = nil %}
        {% if country_code == 'it' %}{% assign matched_color_list = colors_it %} {% endif %}
        {% if country_code == 'gb' %}{% assign matched_color_list = colors_en %} {% endif %}
        {% for i in (0..matched_color_list.size) %}
          {% if matched_color_list[i] == value %}
            {% assign color_index = i %}
            {% break %}
          {% endif %}
        {% endfor %}

        {% if color_index != nil %}
          {% assign value = colors_en[color_index] %}
        {% endif %}
      {% endif %}

      {% assign param = key | append:'=' | append:value %}

      {% if forloop.first %}
        {% assign new_params = param %}
      {% else %}
        {% assign new_params = new_params | append:'&' | append:param %}
      {% endif %}
    {% endfor %}

    {% assign final_url = final_url | append:'?' | append:new_params %}
  {% endif %}

{% endif %}

{{ final_url | strip }}
